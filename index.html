<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CryptoZombies DApp (Ganache Local)</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
  <script src="cryptozombies_abi.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: url('background.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #ffcc99;
      text-align: center;
      margin: 0;
    }

    h2 {
      text-shadow: 0 0 15px #ffa94d, 0 0 25px #ff6600;
      color: #ffe0b3;
      padding-top: 20px;
      margin-bottom: 0;
    }

    #control-bar {
      position: sticky;
      top: 0;
      width: 100%;
      background: rgba(17, 0, 0, 0.85);
      padding: 15px 0;
      z-index: 100;
      border-top: 2px solid #ff9933;
      border-bottom: 2px solid #ff9933;
      box-shadow: 0 0 20px #ff6600;
      margin-top: 10px;
    }

    #control-bar button {
      background-color: #ff6600;
      color: #111;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 10px #ff9933;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    #control-bar button:hover {
      background-color: #ff8533;
      transform: scale(1.05);
      box-shadow: 0 0 20px #ffcc66;
    }

    #txStatus {
      display: block;
      margin-top: 10px;
      font-size: 16px;
      text-shadow: 0 0 10px #ff6600;
      color: #ffe6cc;
      white-space: pre-line;
    }

    #zombies {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin: 40px 20px 60px;
    }

    .zombie {
      background: rgba(0, 0, 0, 0.75);
      border: 2px solid #ff9933;
      border-radius: 15px;
      width: 260px;
      padding: 15px;
      box-shadow: 0 0 15px #ff6600;
      color: #ffe6cc;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .zombie:hover {
      transform: scale(1.03);
      box-shadow: 0 0 25px #ff9933;
    }

    .zombie img {
      width: 200px;
      height: 200px;
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid #ff9933;
      box-shadow: 0 0 10px #ff6600;
    }

    .zombie.selected {
      border: 2px solid #66ff99;
      box-shadow: 0 0 30px #99ffcc !important;
    }
  </style>
</head>

<body>
  <h2>CryptoZombies DApp (Ganache Local)</h2>

  <div id="control-bar">
    <button class="showZombieButton">Show Zombies</button>
    <button class="createzombieButton">Create Zombie</button>
    <button class="levelupButton">Level Up</button>
    <button class="breedButton">Breed Zombies</button>
    <div id="txStatus"></div>
  </div>

  <div id="zombies"></div>

  <script>
    // ðŸ”§ Update this when you redeploy
    const CONTRACT_ADDRESS = "0xDE2e648483F99eadf6473AA451c16D570746ad3F";

    var cryptoZombies;
    var userAccount;

    const showZombieButton   = document.querySelector('.showZombieButton');
    const createzombieButton = document.querySelector('.createzombieButton');
    const levelupButton      = document.querySelector('.levelupButton');
    const breedButton        = document.querySelector('.breedButton');

    let selectedZombies = [];
    let breedMode = false;

    // âœ… Connect & Initialize DApp
    async function startApp() {
      cryptoZombies = new web3.eth.Contract(cryptoZombiesABI, CONTRACT_ADDRESS);

      const accounts = await web3.eth.getAccounts();
      userAccount = accounts[0];
      console.log("Connected account:", userAccount);

      // Sanity check: does breedZombies exist in ABI?
      const hasBreed = !!cryptoZombies.methods.breedZombies;
      console.log("ABI has breedZombies:", hasBreed);
      if (!hasBreed) {
        $("#txStatus").text("âŒ ABI does not include breedZombies(). Recompile & migrate, then replace the address.");
      }

      cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
        .on("data", () => getZombiesByOwner(userAccount).then(displayZombies))
        .on("error", console.error);
    }

    // ðŸ§Ÿ Display Zombies
    function displayZombies(ids) {
      $("#zombies").empty();
      ids.forEach((id) => {
        getZombieDetails(id).then((zombie) => {
          const avatarUrl = `https://api.dicebear.com/9.x/bottts/svg?seed=${zombie.dna}&backgroundColor=ff6600,2b0000,5b2d00&backgroundType=gradientLinear`;

          const zombieCard = $(`
            <div class="zombie" data-id="${id}">
              <img src="${avatarUrl}" alt="Zombie Avatar">
              <ul>
                <li><b>ID:</b> ${id}</li>
                <li><b>Name:</b> ${zombie.name}</li>
                <li><b>DNA:</b> ${zombie.dna}</li>
                <li><b>Level:</b> ${zombie.level}</li>
                <li><b>Wins:</b> ${zombie.winCount}</li>
                <li><b>Losses:</b> ${zombie.lossCount}</li>
                <li><b>Ready Time:</b> ${zombie.readyTime}</li>
              </ul>
            </div>
          `);

          // ðŸ§¬ Breed selection logic
          zombieCard.on("click", async function () {
            if (!breedMode) return;
            const zombieId = $(this).data("id");
            if (selectedZombies.includes(zombieId)) return; // already selected

            selectedZombies.push(zombieId);
            $(this).addClass("selected");
            $("#txStatus").text(`ðŸ§¬ Selected: ${selectedZombies.join(", ")}. Pick one more...`);

            if (selectedZombies.length === 2) {
              const childName = prompt("Enter the new zombie's name:");
              if (childName && childName.trim().length > 0) {
                await breedZombiesTx(selectedZombies[0], selectedZombies[1], childName.trim());
              } else {
                $("#txStatus").text("âš ï¸ Breeding cancelled (no name).");
              }

              // reset selection whether success or fail
              selectedZombies = [];
              breedMode = false;
              breedButton.textContent = "Breed Zombies";
              $(".zombie").removeClass("selected");
            }
          });

          $("#zombies").append(zombieCard);
        });
      });
    }

    // ðŸ” On-chain breed call (debug-friendly)
    async function breedZombiesTx(parent1Id, parent2Id, childName) {
      try {
        $("#txStatus").text("ðŸ§¬ Breeding in progress... (confirm in MetaMask)");

        // Extra ABI/addr guard
        if (!cryptoZombies || !cryptoZombies.methods || !cryptoZombies.methods.breedZombies) {
          $("#txStatus").text("âŒ Contract method breedZombies() not found. Check ABI/address.");
          return;
        }

        console.log("Calling breedZombies(", parent1Id, parent2Id, childName, ")");

        const receipt = await cryptoZombies.methods
          .breedZombies(parent1Id, parent2Id, childName)
          .send({ from: userAccount, gas: 500000 });

        console.log("âœ… Transaction receipt:", receipt);

        // Try to read NewZombie event (common in CryptoZombies)
        let bornId = null;
        if (receipt && receipt.events) {
          // Supports both receipt.events.NewZombie and numeric keys
          const evt = receipt.events.NewZombie || Object.values(receipt.events).find(e => e.event === "NewZombie");
          if (evt && evt.returnValues && evt.returnValues.zombieId !== undefined) {
            bornId = evt.returnValues.zombieId;
          }
        }

        $("#txStatus").text(
          bornId !== null
            ? `ðŸŽ‰ New zombie created! ID: ${bornId} â€” "${childName}"`
            : `ðŸŽ‰ New zombie created! (Event not parsed) â€” "${childName}"`
        );

        // Refresh list
        getZombiesByOwner(userAccount).then(displayZombies);

      } catch (error) {
        console.error("âŒ Breeding failed:", error);
        const msg = (error && error.message) ? error.message : String(error);
        $("#txStatus").text(`âŒ Breeding failed: ${msg}`);
      }
    }

    // ðŸ§¬ Create Zombie
    function createRandomZombie(name) {
      $("#txStatus").text("Creating new zombie...");
      cryptoZombies.methods.createRandomZombie(name)
        .send({ from: userAccount, gas: 500000 })
        .on("transactionHash", (hash) => {
          $("#txStatus").text(`Creating new zombie...\nTx: ${hash}`);
        })
        .on("receipt", function () {
          $("#txStatus").text("Successfully created " + name + "!");
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          $("#txStatus").text("Error: " + error.message);
        });
    }

    // âš¡ Level Up Zombie
    function levelUp(zombieId) {
      $("#txStatus").text("Leveling up your zombie...");
      cryptoZombies.methods.levelUp(zombieId)
        .send({ from: userAccount, value: web3.utils.toWei("0.001", "ether"), gas: 500000 })
        .on("receipt", function () {
          $("#txStatus").text("Zombie leveled up!");
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          $("#txStatus").text("Error: " + error.message);
        });
    }

    // ðŸ§  Helper Functions
    function getZombieDetails(id) {
      return cryptoZombies.methods.zombies(id).call();
    }
    function getZombiesByOwner(owner) {
      return cryptoZombies.methods.getZombiesByOwner(owner).call();
    }

    // ðŸ”— Connect to Ganache
    window.addEventListener("load", async () => {
      try {
        web3 = new Web3("http://127.0.0.1:7545");
        await startApp();
        console.log("âœ… Connected to Ganache");
      } catch (err) {
        console.error("âŒ Failed to connect:", err);
        document.getElementById("txStatus").innerText =
          "âš ï¸ Unable to connect to Ganache (127.0.0.1:7545)";
      }
    });

    // ðŸ•¹ï¸ Button Handlers
    createzombieButton.addEventListener('click', () => {
      const name = prompt("Enter your zombie's name:");
      if (name) createRandomZombie(name);
    });

    showZombieButton.addEventListener('click', () => {
      getZombiesByOwner(userAccount).then(displayZombies);
    });

    levelupButton.addEventListener('click', () => {
      const id = prompt("Enter the ID of the zombie to level up:");
      if (id !== null && id !== "") levelUp(id);
    });

    // ðŸ§¬ Toggle Breed Mode
    breedButton.addEventListener('click', () => {
      breedMode = !breedMode;
      selectedZombies = [];
      $("#txStatus").text(breedMode ? "ðŸ§¬ Select two zombies to breed..." : "");
      breedButton.textContent = breedMode ? "Cancel Breed" : "Breed Zombies";
      $(".zombie").removeClass("selected");
    });
  </script>
</body>
</html>
